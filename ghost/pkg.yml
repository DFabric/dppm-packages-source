package: ghost
name: Ghost
type: app
keywords: [nodejs, blog, cms]
license: MIT
url: https://ghost.org/
docs: https://docs.ghost.org
description: Simple and powerful blogging/publishing platform
info: After the installation visit /ghost and create your admin user to login to the Ghost admin

deps:
  nodejs: ^6.9.0 || ^8.9.0

version:
  self:
    src: https://github.com/TryGhost/Ghost
    regex: '(?<=data-name=")[0-9.]+(?=")'

tags:
  latest:
    src: https://github.com/TryGhost/Ghost/releases/latest
    regex: (?<=tag/).*(?=">)

config:
  url: url
  host: server.host
  port: server.port
  database_type: database.client # sqlite3/mysql
  database_host: database.connection.host
  database_user: database.connection.user
  database_password: database.connection.password
  database_name: database.connection.database

vars:
- lib/ghost/package.json
- lib/ghost/core/server/config/defaults.json

exec:
  start: lib/nodejs/bin/node lib/ghost/index.js

tasks:
  build:
  - write etc/npmrc "scripts-prepend-node-path = true"
  - node lib/nodejs/lib/node_modules/npm --scripts-prepend-node-path lib/nodejs/bin install ghost -g --unsafe-perm --prefix .
  - mv lib/node_modules/ghost lib/ghost
  - mv lib/ghost/content srv
  - rm_r lib/node_modules etc/npmrc

  # Symlink to standard locations
  - rm lib/ghost/core/server/config/env/config.production.json
  - symlink ../../../../../../etc/config.json lib/ghost/core/server/config/env/config.production.json
  - append lib/ghost/node_modules/knex-migrator/logging.js "; process.env.NODE_ENV = "production""

  add:
  # Init or migrate database if needed
  - cd lib/ghost
  - node node_modules/knex-migrator/bin/knex-migrator-init
  - node node_modules/knex-migrator/bin/knex-migrator-migrate
