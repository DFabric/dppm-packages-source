package: ghost
name: Ghost
type: app
license: MIT
url: https://ghost.org/
docs: https://docs.ghost.org
description: Simple and powerful blogging/publishing platform
info: After the installation visit /ghost and create your admin user to login to the Ghost admin
shared: false

deps:
  nodejs: ^6.9.0 || ^8.9.0

shared: false

version:
  self:
    src: https://github.com/TryGhost/Ghost
    regex: '(?<=data-name=")[0-9.]+(?=")'

tags:
  latest:
    src: https://github.com/TryGhost/Ghost/releases/latest
    regex: (?<=tag/).*(?=">)

config:
  url: url
  host: server.host
  port: server.port
  database_type: database.client
  database_host: database.connection.host
  database_user: database.connection.user
  database_password: database.connection.password
  database_name: database.connection.database

databases:
  sqlite3: null
  mysql: null

vars:
- app/package.json
- app/core/server/config/defaults.json

exec:
  start: lib/nodejs/bin/node app/index.js

env:
  NODE_ENV: production
  paths__contentPath: ../srv

tasks:
  build:
  - write etc/npmrc "scripts-prepend-node-path = true"
  - node lib/nodejs/lib/node_modules/npm --scripts-prepend-node-path lib/nodejs/bin install ghost@${VERSION} -g --unsafe-perm --only=production --prefix .
  - mv lib/node_modules/ghost app
  - mv app/content srv
  - rm_r lib/node_modules etc/npmrc
  - append app/node_modules/knex-migrator/logging.js "; process.env.NODE_ENV = "production""

  add:
  # Symlink to standard locations
  - rm app/core/server/config/env/config.production.json
  - symlink ../../../../../etc/config.json app/core/server/config/env/config.production.json

  # Initialize/migrate database if needed
  - cd app
  - node node_modules/knex-migrator/bin/knex-migrator-init
  - node node_modules/knex-migrator/bin/knex-migrator-migrate
